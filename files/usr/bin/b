#!/bin/bash

BOINCCMD="boinccmd --passwd $BOINC_PASSWD"

list_task(){
	echo "Current tasks:"
	$BOINCCMD --get_tasks |\
		sed -r -e '/^   (name|project URL|active_task_state)/!d'\
		-e 's/   name: //g'\
		-e 's/   project URL: /\t/g'\
		-e 's/   active_task_state: /\t/g'
};

case $1 in

s) # Suspend all tasks
	echo -e "\e[93m[BOINC]\e[92m Suspending every tasks\e[0m"
	$BOINCCMD --get_tasks \
	|sed -r -e '/^   (name|project URL)/!d' -e 's/   name: //g' \
	|sed -r -e ':a;N;$!ba;s/\n^   project URL://g' \
	|awk -v boincpwd=$BOINC_PASSWD \
	'{\
		task[NR]=$1; url[NR]=$2;\
	}\
	END{
		for(x=1; x <= NR; x++){ \
			print "boinccmd --passwd " boincpwd " --task " url[x] " " task[x] " suspend"; \
		} \
	}'\
	| bash -
	sleep 3;
	list_task
	;;
	
sp) # Suspend all Projects
	echo -e "\e[93m[BOINC]\e[92m Suspending every projects\e[0m"
	for url in $($BOINCCMD --get_project_status | sed -n 's/\s*master URL: //p'); do
		$BOINCCMD --project ${url} "suspend"
		echo "Suspending project : ${url}"
	done
	list_task
	;;
	
r) # Resume all tasks
	echo -e "\e[93m[BOINC]\e[92m Resuming every tasks\e[0m"
	$BOINCCMD --get_tasks \
	|sed -r -e '/^   (name|project URL)/!d' -e 's/   name: //g' \
	|sed -r -e ':a;N;$!ba;s/\n^   project URL://g' \
	|awk -v boincpwd=$BOINC_PASSWD \
	'{\
		task[NR]=$1; url[NR]=$2;\
	}\
	END{
		for(x=1; x <= NR; x++){ \
			print "boinccmd --passwd " boincpwd " --task " url[x] " " task[x] " resume"; \
		}\
	}'\
	| bash -
	sleep 3;
	list_task
	;;
	
rp) # Resume all Projects
	echo -e "\e[93m[BOINC]\e[92m Resuming every projects\e[0m"
	for url in $($BOINCCMD --get_project_status | sed -n 's/\s*master URL: //p'); do
		$BOINCCMD --project ${url} resume
		echo "Resuming project : ${url}"
	done
	list_task
	;;
	
a) # Abort all
	echo -e "\e[93m[BOINC]\e[92m Aborting every tasks\e[0m"
	$BOINCCMD --get_tasks \
	|sed -r -e '/^   (name|project URL)/!d' -e 's/   name: //g' \
	|sed -r -e ':a;N;$!ba;s/\n^   project URL://g' \
	|awk -v boincpwd=$BOINC_PASSWD \
	'{\
		task[NR]=$1; url[NR]=$2;\
	}\
	END{
		for(x=1; x <= NR; x++){ \
			print "boinccmd --passwd " boincpwd " --task " url[x] " " task[x] " abort"; \
		}\
	}'\
	| bash -
	sleep 3;
	list_task
	;;
	
u) # Update all project and sync
	echo -e "\e[93m[BOINC]\e[92m Updating every projects and syncing to account manager\e[0m"
	for url in $($BOINCCMD --get_project_status | sed -n 's/\s*master URL: //p'); do
		$BOINCCMD --project ${url} update
		echo "Updating project : ${url}"
	done
	echo -e "\e[93m[BOINC]\e[92m Syncing account manager...\e[0m"
	$BOINCCMD --acct_mgr sync
	echo -e "\e[93m[BOINC]\e[92m BOINC projects and account manager sync completed\e[0m"
	$BOINCCMD --acct_mgr info
	sleep 2
	list_task
	;;
	
k) # Kill daemon
	killall boinc
	;;

i) # Start daemon
	echo -e "\e[93m[BOINC]\e[92m Starting BOINC client\e[0m"
	if ! pgrep "boinc"; then
		# Start BOINC daemon
		boinc --allow_remote_gui_rpc --dir $BOINC_DATADIR && \
			echo -e "\e[93m[BOINC]\e[92m Running BOINC\e[0m"
	else
		# BOINC daemon already running; "do nothing".
		echo -e "\e[93m[BOINC]\e[92m BOINC already running\e[0m"
	fi
	;;

p) # daemon check
	ps -e | grep boinc
	;;
	
c) # Command direct input
	$BOINCCMD $@
	;;
	
d) # Show status
	$BOINCCMD --get_state | more
	;;
	
m) # Messages
	$BOINCCMD --get_messages
	;;
	
w) # Watch tasks
	watch -n 1 "$BOINCCMD --get_tasks | sed -r -e '/^   (name|project URL|active_task_state)/!d' -e 's/   name: //g' -e 's/   project URL: /\t/g' -e 's/   active_task_state: /\t/g'"
	exit
	;;
	
*)
	echo "boinccmd wrapper"
	echo "Usage: bt [options]"
	echo ""
	echo "options:"
	echo -e "\ts\tSuspend all tasks (can fetch new tasks)"
	echo -e "\tsp\tSuspend projects"
	echo -e "\tr\tResume all tasks"
	echo -e "\trp\tResume projects"
	echo -e "\ta\tAbort all tasks"
	echo -e "\tu\tUpdate(Sync) projects and manager"
	echo -e "\tc\tDirect command to boinccmd"
	echo -e "\td\tDetailed messages"
	echo -e "\ti\tStart(init) BOINC daemon"
	echo -e "\tk\tKill BOINC daemon"
	echo -e "\tp\tCheck BOINC daemon running"
	echo -e "\tw\tWatch tasks"
	;;
	
esac