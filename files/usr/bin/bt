#!/bin/bash

BOINC_CMD="boinccmd --passwd $BOINC_PASSWD"

case $1 in

s) # Suspend all
	echo "Suspending every tasks"
	$BOINC_CMD --get_tasks \
	|sed -r -e '/^   (name|project URL)/!d' -e 's/   name: //g' \
	|sed -r -e ':a;N;$!ba;s/\n^   project URL://g' \
	|awk -v boincpwd=$BOINC_PASSWD \
	'{\
		task[NR]=$1; url[NR]=$2;\
	}\
	END{
		for(x=1; x <= NR; x++){ \
			print "boinccmd --passwd " boincpwd " --task " url[x] " " task[x] " suspend"; \
		}\
	}'\
	| bash -
	sleep 3;
	;;
	
sp) # Suspend all Projects
	echo "Suspending every projects"
	for url in $($BOINC_CMD --get_project_status | sed -n 's/\s*master URL: //p'); do
		$BOINC_CMD --project ${url} "suspend"
		echo "Suspending project : ${url}"
	done
	;;
	
r) # Resume all
	echo "Resuming every tasks"
	$BOINC_CMD --get_tasks \
	|sed -r -e '/^   (name|project URL)/!d' -e 's/   name: //g' \
	|sed -r -e ':a;N;$!ba;s/\n^   project URL://g' \
	|awk -v boincpwd=$BOINC_PASSWD \
	'{\
		task[NR]=$1; url[NR]=$2;\
	}\
	END{
		for(x=1; x <= NR; x++){ \
			print "boinccmd --passwd " boincpwd " --task " url[x] " " task[x] " resume"; \
		}\
	}'\
	| bash -
	sleep 3;
	;;
	
rp) # Resume all Projects
	echo "Resuming every projects"
	for url in $($BOINC_CMD --get_project_status | sed -n 's/\s*master URL: //p'); do
		$BOINC_CMD --project ${url} resume
		echo "Resuming project : ${url}"
	done
	;;
	
a) # Abort all
	echo "Aborting every tasks"
	$BOINC_CMD --get_tasks \
	|sed -r -e '/^   (name|project URL)/!d' -e 's/   name: //g' \
	|sed -r -e ':a;N;$!ba;s/\n^   project URL://g' \
	|awk -v boincpwd=$BOINC_PASSWD \
	'{\
		task[NR]=$1; url[NR]=$2;\
	}\
	END{
		for(x=1; x <= NR; x++){ \
			print "boinccmd --passwd " boincpwd " --task " url[x] " " task[x] " abort"; \
		}\
	}'\
	| bash -
	sleep 3;
	;;
	
u) # Update all project and sync
	echo "Updating every projects and syncing to account manager"
	for url in $($BOINC_CMD --get_project_status | sed -n 's/\s*master URL: //p'); do
		$BOINC_CMD --project ${url} update
		echo "Updating project : ${url}"
	done
	echo "Syncing account manager"
	$BOINC_CMD --acct_mgr sync
	echo ">> BOINC projects and account manager sync completed."
	$BOINC_CMD --acct_mgr info
	;;
	
k) # Kill prcess
	killall boinc
	;;
	
p) # Process check
	ps -e | grep boinc
	;;
	
c) # Command direct input
	$BOINC_CMD $@
	;;
	
d) # Show status
	$BOINC_CMD --get_state | more
	;;
	
m) # Messages
	$BOINC_CMD --get_messages
	;;
	
w) # Watch tasks
	watch -n 1 "$BOINC_CMD --get_tasks | sed -r -e '/^   (name|project URL|active_task_state)/!d' -e 's/   name: //g' -e 's/   project URL: /\t/g' -e 's/   active_task_state: /\t/g'"
	exit
	;;
	
*)
	echo "boinccmd wrapper"
	echo "Usage: bt [options]"
	echo ""
	echo "options:"
	echo -e "\ts\tSuspend"
	echo -e "\tsp\tSuspend Projects"
	echo -e "\tr\tResume"
	echo -e "\trp\tResume Projects"
	echo -e "\ta\tabort"
	echo -e "\tu\tUpdate(Sync)"
	echo -e "\tk\tKill"
	echo -e "\tp\tProcess check"
	echo -e "\tc\tCommand to boinccmd"
	echo -e "\td\tDetailed messages"
	echo -e "\tw\tWatch tasks"
	;;
	
esac

echo "Current tasks:"
$BOINC_CMD --get_tasks |\
	sed -r -e '/^   (name|project URL|active_task_state)/!d'\
	-e 's/   name: //g'\
	-e 's/   project URL: /\t/g'\
	-e 's/   active_task_state: /\t/g'\
